<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Teacher Live Report</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <!-- Google Fonts: Poppins & Lato -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@700&family=Lato:wght@400&display=swap" rel="stylesheet">
  <!-- Firebase SDKs (Modular v9+ syntax) -->
  <link href="assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
  <style>
    :root {
      --primary-color: #1A73E8; /* Royal Blue */
      --secondary-color: #0D1B2A; /* Deep Navy */
      --text-color: #303030; /* Charcoal */
      --success-color: #198754;
      --danger-color: #dc3545;
      --warning-color: #ffc107;
      --bg-color: #F7F9FC; /* Cool Grey */
      --card-bg: #FFFFFF;
    }
    body {
      font-family: 'Lato', sans-serif;
      background-color: var(--bg-color);
      color: var(--text-color);
      min-height: 100vh;
    }
    h2, h3 {
      font-family: 'Poppins', sans-serif;
      font-weight: 700;
      color: var(--primary-color);
    }
    .table-container {
      background-color: #fff;
      border-radius: 16px;
      padding: 2rem;
      box-shadow: 0 8px 25px rgba(0,0,0,0.1);
    }
    .table thead th {
      background-color: var(--primary-color);
      color: #fff;
      border-bottom: 0;
    }
    .table tbody tr:hover {
      background-color: rgba(0, 87, 183, 0.05);
    }
    .table td {
      vertical-align: middle;
    }
    .text-success { color: var(--success-color) !important; }
    .text-danger { color: var(--danger-color) !important; }
    .text-warning { color: var(--warning-color) !important; }

    /* Login / Hero Styles matching index.html */
    #login-section {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(180deg, rgba(26, 115, 232, 0.06), rgba(255,255,255,0.02));
      padding: 2rem;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      z-index: 9999;
    }
    .login-card {
      width: 100%;
      max-width: 520px;
      background: var(--card-bg);
      padding: 2.5rem;
      border-radius: 1rem;
      box-shadow: 0 10px 40px rgba(12,16,40,0.08);
      text-align: center;
      border: 1px solid rgba(0,0,0,0.04);
    }
  </style>
</head>
<body class="p-4" style="background-color: var(--bg-color);">
  <!-- LOGIN SECTION -->
  <section id="login-section">
    <div class="login-card">
      <div class="mb-4">
        <span class="badge bg-primary-subtle text-primary rounded-pill px-3 py-2 mb-3" style="background-color: rgba(26, 115, 232, 0.1); color: var(--primary-color);">Admin Access</span>
        <h1 class="h2 mb-2" style="font-family: 'Poppins', sans-serif; font-weight: 700; color: var(--secondary-color);">Tutor Dashboard</h1>
        <p class="text-muted">Enter your secure passphrase to access live student reports.</p>
      </div>

      <div class="form-floating mb-3 text-start">
        <input type="password" class="form-control" id="password-input" placeholder="Password">
        <label for="password-input">Passphrase</label>
      </div>

      <button id="login-btn" class="btn btn-primary btn-lg w-100 py-3 fw-bold" style="background-color: var(--primary-color); border: none; box-shadow: 0 4px 12px rgba(26, 115, 232, 0.2);">Unlock Dashboard</button>

      <div id="error-alert" class="alert alert-danger mt-3 small" style="display: none;">
        <i class="bi bi-exclamation-circle me-2"></i>Incorrect password. Please try again.
      </div>
    </div>
  </section>

  <div id="report-section" class="container-fluid" style="display: none;">
    <header class="text-center mb-5">
      <h2>üìä Live Teacher Dashboard</h2>
      <p class="text-muted">Real-time results from student quiz submissions</p>
      <small id="lastUpdated" class="text-muted"></small>
    </header>

    <!-- KPI CARDS -->
    <div class="row g-4 mb-5" id="kpi-cards">
      <div class="col-md-4">
        <div class="kpi-card card h-100">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
              <h5 class="card-title">Total Submissions</h5>
              <i class="bi bi-people-fill kpi-icon"></i>
            </div>
            <p id="totalSubmissions" class="kpi-value">0</p>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="kpi-card card h-100">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
              <h5 class="card-title">Average Score</h5>
              <i class="bi bi-check2-circle kpi-icon"></i>
            </div>
            <p id="averageScore" class="kpi-value">0%</p>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="kpi-card card h-100">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
              <h5 class="card-title">Most Common Error</h5>
              <i class="bi bi-exclamation-triangle-fill kpi-icon"></i>
            </div>
            <p id="mostCommonError" class="kpi-value">-</p>
          </div>
        </div>
      </div>
    </div>

    <div class="table-container">
      <div class="table-responsive">
        <table class="table table-hover text-center">
          <thead>
            <tr>
              <th class="text-start sortable" data-sort="taskId">NAME <i class="bi bi-arrow-down-up"></i></th>
              <th class="sortable" data-sort="correct">CORRECT <i class="bi bi-arrow-down-up"></i></th>
              <th class="sortable" data-sort="incorrect">INCORRECT <i class="bi bi-arrow-down-up"></i></th>
              <th class="sortable" data-sort="missed">MISSED <i class="bi bi-arrow-down-up"></i></th>
              <th>INCORRECT QUESTIONS</th>
              <th>MISSED QUESTIONS</th>
            </tr>
          </thead>
          <tbody id="reportTableBody"></tbody>
        </table>
      </div>
    </div>

    <!-- ACTION BUTTONS -->
    <div id="action-buttons" class="container mt-4 d-flex justify-content-center flex-wrap gap-3">
      <button id="questionAnalysisBtn" class="btn btn-primary"><i class="bi bi-bar-chart-line me-2"></i>Question Analysis</button>
      <button id="findCommonErrorBtn" class="btn btn-info text-white"><i class="bi bi-search me-2"></i>Find Common Error</button>
      <button id="clearAllBtn" class="btn btn-danger"><i class="bi bi-trash me-2"></i>Clear All Results</button>
    </div>

    <style>
      .kpi-card {
        border: none;
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
      }
      .kpi-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.08);
      }
      .kpi-card .card-title {
        font-size: 1rem;
        font-weight: 600;
        color: var(--text-color);
      }
      .kpi-icon {
        font-size: 1.5rem;
        color: var(--primary-color);
        opacity: 0.7;
      }
      .kpi-value {
        font-size: 2.5rem;
        font-weight: 700;
        color: var(--primary-color);
        margin-top: 0.5rem;
        margin-bottom: 0;
      }
      .sortable { cursor: pointer; }
      .sortable:hover { background-color: rgba(255,255,255,0.1); }
    </style>
  </div>

  <!-- Modal for Common Error -->
  <div class="modal fade" id="commonErrorModal" tabindex="-1" aria-labelledby="commonErrorModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="commonErrorModalLabel">Most Common Error</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="commonErrorBody">
          <!-- Content will be injected by JS -->
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal for Student Details -->
  <div class="modal fade" id="studentDetailModal" tabindex="-1" aria-labelledby="studentDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="studentDetailModalLabel">Student Details</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="studentDetailBody">
          <!-- Detailed results will be injected here -->
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal for Question Analysis -->
  <div class="modal fade" id="questionAnalysisModal" tabindex="-1" aria-labelledby="questionAnalysisModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="questionAnalysisModalLabel">Question Performance Analysis</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="questionAnalysisBody">
          <!-- Question analysis will be injected here -->
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal for Answer Distribution -->
  <div class="modal fade" id="answerDistributionModal" tabindex="-1" aria-labelledby="answerDistributionModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="answerDistributionModalLabel">Answer Distribution</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="answerDistributionBody">
          <!-- Distribution chart will be injected here -->
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS (needed for Modal) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getDatabase, ref, onValue, remove } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

    // --- Firebase Config ---
    const firebaseConfig = {
      apiKey: "AIzaSy***Q",
      authDomain: "ielts-live-dashboard.firebaseapp.com",
      databaseURL: "https://ielts-live-dashboard-default-rtdb.firebaseio.com",
      projectId: "ielts-live-dashboard",
      storageBucket: "ielts-live-dashboard.firebasestorage.app",
      messagingSenderId: "1044694021318",
      appId: "1:1044694021318:web:70f1ac1ba0787d37da93c7",
      measurementId: "G-R9G2YGSBM9"
    };

    // --- Initialize Firebase ---
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // --- Login Logic ---
    const loginSection = document.getElementById('login-section');
    const reportSection = document.getElementById('report-section');
    const loginBtn = document.getElementById('login-btn');
    const passwordInput = document.getElementById('password-input');
    const errorAlert = document.getElementById('error-alert');

    loginBtn.addEventListener('click', () => {
      if (passwordInput.value === '3753') {
        loginSection.style.display = 'none';
        document.body.style.backgroundColor = 'var(--bg-color)'; // Reset body background
        reportSection.style.display = 'block';
        errorAlert.style.display = 'none';
      } else {
        errorAlert.style.display = 'block';
      }
    });

    // Allow Enter key to trigger login
    passwordInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        loginBtn.click();
      }
    });

    // --- Data Store ---
    let allRecords = []; // To store all records for analysis
    const QUESTIONS = [ // Mirroring quiz.html to get question text
      { q:"1. Choose the grammatically correct passive form: ‚ÄúResearchers have recently conducted several studies on climate change.‚Äù", options:["A. Several studies have been conduct on climate change recently.","B. Several studies were being conducted on climate change recently.","C. Several studies have recently conducting on climate change.","D. Several studies have recently been conducted on climate change."], correct:"D" },
      { q:"2. Which sentence correctly uses a gerund after a reporting verb?", hint:"Some reporting verbs (e.g. <i>recommend, suggest, avoid</i>) are followed by <b>verb + ing</b>, not <i>to + verb</i>.", options:["A. The committee recommended to revise the policy immediately.","B. The committee recommended revise the policy immediately.","C. The committee recommended to revising the policy immediately.","D. The committee recommended revising the policy immediately."], correct:"D" },
      { q:"3. Identify the sentence that is grammatically correct and academically appropriate.", options:["A. There are many factors cause unemployment in cities.","B. There are many factors which cause unemployment in cities.","C. There are many factors that causing unemployment in cities.","D. There are many factors that cause unemployment in cities."], correct:"D" },
      { q:"4. Choose the correctly structured complex sentence with logical subordination.", options:["A. Public transport was improved, congestion was reduced.","B. Public transport was improved and congestion reducing.","C. Public transport was improved, reducing congestion in cities.","D. Public transport was improved because congestion had become severe."], correct:"D" },
      { q:"5. Which option demonstrates correct control of clause structure?", hint:"When using <i>while</i>, check that <b>both clauses are complete and grammatically balanced</b>.", options:["A. While the economy expanded, unemployment reducing.","B. While the economy expanded, unemployment reduce.","C. While the economy expanded, unemployment was reduce.","D. While the economy expanded, unemployment was reduced."], correct:"D" },
      { q:"6. Choose the sentence with correct infinitive usage.", hint:"After verbs like <i>aim, plan, decide</i>, use <b>to + base verb</b>.", options:["A. The government aims reducing inequality through education.","B. The government aims reduce inequality through education.","C. The government aims to reducing inequality through education.","D. The government aims to reduce inequality through education."], correct:"D" },
      { q:"7. Which sentence reflects accurate grammatical control expected in IELTS Task 2?", options:["A. The data analysed by experts reveal a clear trend.","B. The data was analysed and reveal a clear trend.","C. The data analysed reveals clear trend.","D. The data analysed by experts reveal a clear trend."], correct:"D" },
      { q:"8. A line graph shows that internet usage rose sharply between 2005 and 2010, before levelling off until 2020. Which statement is MOST accurate?", options:["A. Internet usage declined steadily after 2010.","B. Internet usage fluctuated considerably throughout the period.","C. Internet usage continued to rise at the same pace after 2010.","D. Internet usage increased rapidly initially and then stabilised."], correct:"D" },
      { q:"9. What does the word ‚Äúadamant‚Äù most precisely mean?", options:["A. Willing to negotiate under pressure","B. Uncertain about one‚Äôs stance","C. Open to alternative viewpoints","D. Refusing to change one‚Äôs mind; unyielding"], correct:"D" },
      { q:"10. What is the closest meaning of ‚Äúallure‚Äù in academic context?", options:["A. A logical explanation","B. A temporary trend","C. A financial incentive","D. The power to attract or charm"], correct:"D" }
    ];

    // --- Table Element ---
    const tableBody = document.getElementById("reportTableBody");

    // --- KPI Elements ---
    const totalSubmissionsEl = document.getElementById('totalSubmissions');
    const averageScoreEl = document.getElementById('averageScore');
    const mostCommonErrorEl = document.getElementById('mostCommonError');
    const lastUpdatedEl = document.getElementById('lastUpdated');

    // --- Real-time Listener ---
    const resultsRef = ref(db, "quizResults");
    onValue(resultsRef, (snapshot) => {
      const data = snapshot.val() || {};
      allRecords = Object.values(data); // Store for analysis
      renderTable(allRecords);
      updateKpis(allRecords);
      lastUpdatedEl.textContent = `Last updated: ${new Date().toLocaleTimeString()}`;
    }, (error) => {
      console.error("‚ùå Firebase read error:", error.message);
    });

    function renderTable(records) {
      tableBody.innerHTML = "";
      if (records.length > 0) {
        // convert to array so we can reverse order (newest first)
        records.forEach(record => {
          const row = `
            <tr class="animate-fade-in student-row" data-student-key="${record.taskId}" style="cursor: pointer;">
              <td class="fw-bold text-start">${record.taskId}</td>
              <td class="fw-bold text-success">${record.correct}</td>
              <td class="fw-bold text-danger">${record.incorrect}</td>
              <td class="fw-bold text-warning">${record.missed}</td>
              <td>${record.incorrectQuestions || "-"}</td>
              <td>${record.missedQuestions || "-"}</td>
            </tr>`;
          tableBody.insertAdjacentHTML("beforeend", row);
        });
      } else {
        // Updated colspan to 6
        tableBody.innerHTML = `<tr><td colspan="6" class="text-muted text-center p-4">No results found yet. Waiting for first submission...</td></tr>`;
      }

      // Add click listeners for the new rows
      document.querySelectorAll('.student-row').forEach(row => {
        row.addEventListener('click', () => {
          showStudentDetails(row.dataset.studentKey);
        });
      });
    }

    function updateKpis(records) {
      totalSubmissionsEl.textContent = records.length;

      if (records.length === 0) {
        averageScoreEl.textContent = '0%';
        mostCommonErrorEl.textContent = '-';
        return;
      }

      // Calculate Average Score
      const totalCorrect = records.reduce((sum, record) => sum + (parseFloat(record.correct) || 0), 0);
      const avgScore = (totalCorrect / records.length).toFixed(1);
      averageScoreEl.textContent = `${avgScore}%`;

      // Find Most Common Error
      const wrongCounts = {};
      records.forEach(record => {
        if (record.rawAnswers && record.rawAnswers.length === QUESTIONS.length) {
          record.rawAnswers.forEach((answer, index) => {
            if (answer !== null && answer !== QUESTIONS[index].correct) {
              const questionNumber = index + 1;
              wrongCounts[questionNumber] = (wrongCounts[questionNumber] || 0) + 1;
            }
          });
        }
      });

      if (Object.keys(wrongCounts).length > 0) {
        const mostCommon = Object.entries(wrongCounts).sort((a, b) => b[1] - a[1])[0];
        mostCommonErrorEl.textContent = `Question ${mostCommon[0]}`;
      } else {
        mostCommonErrorEl.textContent = 'None';
      }
    }

    // --- Sorting Logic ---
    let sortColumn = 'timestamp';
    let sortDirection = 'desc';

    document.querySelectorAll('.sortable').forEach(header => {
      header.addEventListener('click', () => {
        const column = header.dataset.sort;
        if (sortColumn === column) {
          sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
        } else {
          sortColumn = column;
          sortDirection = 'asc';
        }
        
        const sortedRecords = [...allRecords].sort((a, b) => {
          let valA = a[column];
          let valB = b[column];
          if (column !== 'taskId') { // For percentages, parse them as numbers
            valA = parseFloat(valA) || 0;
            valB = parseFloat(valB) || 0;
          }
          return (valA > valB ? 1 : -1) * (sortDirection === 'asc' ? 1 : -1);
        });
        renderTable(sortedRecords);
      });
    });

    // --- Action Button Logic ---
    const findCommonErrorBtn = document.getElementById('findCommonErrorBtn');
    const clearAllBtn = document.getElementById('clearAllBtn');
    const commonErrorModal = new bootstrap.Modal(document.getElementById('commonErrorModal'));
    const answerDistributionModal = new bootstrap.Modal(document.getElementById('answerDistributionModal'));
    const questionAnalysisModal = new bootstrap.Modal(document.getElementById('questionAnalysisModal'));
    const studentDetailModal = new bootstrap.Modal(document.getElementById('studentDetailModal'));
    const questionAnalysisBtn = document.getElementById('questionAnalysisBtn');
    const commonErrorBody = document.getElementById('commonErrorBody');

    findCommonErrorBtn.addEventListener('click', () => {
      if (allRecords.length === 0) {
        commonErrorBody.innerHTML = `<p class="text-muted">No student data available to analyze.</p>`;
        commonErrorModal.show();
        return;
      }

      const wrongCounts = {}; // e.g., { 3: 2, 5: 4 } -> Q#3 wrong twice, Q#5 wrong four times

      allRecords.forEach(record => {
        if (record.rawAnswers && record.rawAnswers.length === QUESTIONS.length) {
          record.rawAnswers.forEach((answer, index) => {
            if (answer !== null && answer !== QUESTIONS[index].correct) {
              const questionNumber = index + 1;
              wrongCounts[questionNumber] = (wrongCounts[questionNumber] || 0) + 1;
            }
          });
        }
      });

      if (Object.keys(wrongCounts).length === 0) {
        commonErrorBody.innerHTML = `<div class="alert alert-success">Great job! No incorrect answers have been recorded across all students.</div>`;
      } else {
        // Find the most common error
        const mostCommon = Object.entries(wrongCounts).sort((a, b) => b[1] - a[1])[0];
        const qNum = mostCommon[0];
        const qCount = mostCommon[1];
        const qText = QUESTIONS[qNum - 1].q;

        commonErrorBody.innerHTML = `
          <p>The most frequently incorrect question is:</p>
          <div class="alert alert-danger">
            <h5 class="alert-heading">Question ${qNum}</h5>
            <p>${qText}</p>
            <hr>
            <p class="mb-0">It was answered incorrectly <strong>${qCount}</strong> time(s).</p>
          </div>
        `;
      }
      commonErrorModal.show();
    });

    clearAllBtn.addEventListener('click', async () => {
      const pass = prompt("To clear all data, please enter the admin passcode:");
      if (pass === '3753') {
        if (confirm("Are you sure you want to permanently delete ALL quiz results? This cannot be undone.")) {
          await remove(resultsRef);
          alert("All quiz results have been cleared.");
        }
      } else if (pass !== null) { // User entered something but it was wrong
        alert("Incorrect passcode. Action cancelled.");
      }
    });

    questionAnalysisBtn.addEventListener('click', () => {
      const questionAnalysisBody = document.getElementById('questionAnalysisBody');
      if (allRecords.length === 0) {
        questionAnalysisBody.innerHTML = `<p class="text-muted">No student data available to analyze.</p>`;
        questionAnalysisModal.show();
        return;
      }

      let analysisHtml = '<ul class="list-group">';
      QUESTIONS.forEach((q, index) => {
        let correctCount = 0;
        let attemptedCount = 0;
        allRecords.forEach(record => {
          if (record.rawAnswers && record.rawAnswers[index] !== null) {
            attemptedCount++;
            if (record.rawAnswers[index] === q.correct) {
              correctCount++;
            }
          }
        });

        const successRate = attemptedCount > 0 ? (correctCount / attemptedCount) * 100 : 0;
        let progressBarClass = 'bg-success';
        if (successRate < 75) progressBarClass = 'bg-warning';
        if (successRate < 50) progressBarClass = 'bg-danger';

        analysisHtml += `
          <li class="list-group-item list-group-item-action" style="cursor: pointer;" data-question-index="${index}" title="${q.hint ? 'Click to see answer distribution. Hint available.' : 'Click to see answer distribution.'}">
            <div class="fw-bold">Q${index + 1}: ${q.q.substring(0, 80)}...</div>
            ${q.hint ? `<div class="text-muted small mt-1"><i class="bi bi-lightbulb text-warning"></i> <strong>Hint:</strong> ${q.hint}</div>` : ''}
            <div class="d-flex align-items-center mt-2">
              <div class="progress" style="height: 20px; flex-grow: 1;">
                <div class="progress-bar ${progressBarClass}" role="progressbar" style="width: ${successRate.toFixed(1)}%;" aria-valuenow="${successRate.toFixed(1)}" aria-valuemin="0" aria-valuemax="100">
                  ${successRate.toFixed(1)}%
                </div>
              </div>
              <small class="ms-3 text-muted" style="min-width: 120px;">(${correctCount}/${attemptedCount} correct)</small>
            </div>
          </li>`;
      });
      analysisHtml += '</ul>';
      questionAnalysisBody.innerHTML = analysisHtml;

      // Add click listeners for the new analysis items
      questionAnalysisBody.querySelectorAll('.list-group-item-action').forEach(item => {
        item.addEventListener('click', () => {
          showAnswerDistribution(item.dataset.questionIndex);
        });
      });
      questionAnalysisModal.show();
    });

    function showStudentDetails(studentKey) {
      const record = allRecords.find(r => r.taskId === studentKey);
      if (!record) return;

      const modalTitle = document.getElementById('studentDetailModalLabel');
      const modalBody = document.getElementById('studentDetailBody');
      modalTitle.textContent = `Details for ${record.taskId}`;

      let detailsHtml = '<div class="list-group">';
      QUESTIONS.forEach((q, index) => {
        const studentAnswer = record.rawAnswers ? record.rawAnswers[index] : null;
        const correctAnswer = q.correct;
        let statusIcon = '';
        let itemClass = '';

        if (studentAnswer === null) {
          statusIcon = '<i class="bi bi-skip-circle-fill text-warning"></i>';
          itemClass = 'list-group-item-warning';
        } else if (studentAnswer === correctAnswer) {
          statusIcon = '<i class="bi bi-check-circle-fill text-success"></i>';
          itemClass = 'list-group-item-success';
        } else {
          statusIcon = '<i class="bi bi-x-circle-fill text-danger"></i>';
          itemClass = 'list-group-item-danger';
        }

        detailsHtml += `
          <div class="list-group-item ${itemClass}">
            <div class="d-flex w-100 justify-content-between">
              <h6 class="mb-1">${q.q}</h6>
              ${statusIcon}
            </div>
            <p class="mb-1 small">Your answer: <strong>${studentAnswer || 'N/A'}</strong> | Correct answer: <strong>${correctAnswer}</strong></p>
          </div>`;
      });
      detailsHtml += '</div>';
      modalBody.innerHTML = detailsHtml;
      studentDetailModal.show();
    }

    function showAnswerDistribution(questionIndex) {
      const qIndex = parseInt(questionIndex);
      const question = QUESTIONS[qIndex];
      const totalStudents = allRecords.length;

      const answerCounts = {};
      question.options.forEach((opt, i) => {
        const letter = String.fromCharCode(65 + i);
        answerCounts[letter] = 0;
      });

      allRecords.forEach(record => {
        if (record.rawAnswers && record.rawAnswers[qIndex] !== null) {
          const studentAnswer = record.rawAnswers[qIndex];
          if (answerCounts.hasOwnProperty(studentAnswer)) {
            answerCounts[studentAnswer]++;
          }
        }
      });

      const modalTitle = document.getElementById('answerDistributionModalLabel');
      const modalBody = document.getElementById('answerDistributionBody');
      modalTitle.textContent = `Answer Distribution for Question ${qIndex + 1}`;

      let distributionHtml = `<h5 class="mb-4">${question.q}</h5>`;
      question.options.forEach((opt, i) => {
        const letter = String.fromCharCode(65 + i);
        const count = answerCounts[letter];
        const percentage = totalStudents > 0 ? (count / totalStudents) * 100 : 0;
        const isCorrect = letter === question.correct;
        const barClass = isCorrect ? 'bg-success' : 'bg-secondary';

        distributionHtml += `
          <div class="mb-3">
            <div class="d-flex justify-content-between">
              <strong>${letter}. ${opt.replace(/^([A-D]\.\s*)/,'')}</strong>
              <span>${count} vote(s)</span>
            </div>
            <div class="progress" style="height: 25px;">
              <div class="progress-bar ${barClass}" role="progressbar" style="width: ${percentage.toFixed(1)}%;" aria-valuenow="${percentage.toFixed(1)}">${percentage.toFixed(1)}%</div>
            </div>
          </div>`;
      });
      modalBody.innerHTML = distributionHtml;
      answerDistributionModal.show();
    }
  </script>
</body>
</html>