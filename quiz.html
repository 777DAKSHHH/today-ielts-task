<!DOCTYPE html>
<html lang="en">
<head>
  <link href="assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>IELTS Quiz</title>

  <!-- Google fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg: #f5f7fb;
      --card: #ffffff;
      --accent: #0f95ff;
      --accent-600: #0d86e6;
      --muted: #6b7280;
      --shadow: 0 18px 40px rgba(12,16,40,0.06);
      --radius: 18px;
      --glass: rgba(255,255,255,0.7);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: "Inter", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background: linear-gradient(180deg,#eef4ff 0%, #f5f7fb 30%);
      display:flex;
      align-items:center;
      justify-content:center;
      min-height:100vh;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }

    /* Outer card (centered) */
    .card {
      width:100%;
      max-width:820px;
      background: var(--card);
      border-radius: 20px;
      padding: 36px;
      box-shadow: var(--shadow);
      position: relative;
      overflow: hidden;
    }

    /* Welcome hero (W2) styles */
    .welcome {
      display: flex;
      gap: 32px;
      align-items: center;
      min-height: 260px;
      padding: 16px 0;
    }

    .welcome-left {
      flex: 1;
      padding-left: 12px;
    }

    .eyebrow {
      display:inline-block;
      background: linear-gradient(90deg, rgba(15,149,255,0.12), rgba(13,134,230,0.08));
      color: var(--accent);
      padding:6px 12px;
      border-radius: 999px;
      font-weight:600;
      font-size:13px;
      margin-bottom: 18px;
    }

    .hero-title {
      font-size: 32px;
      margin: 0 0 8px 0;
      font-weight: 800;
      color: #0b2a4a;
      letter-spacing: -0.6px;
    }

    .hero-sub {
      color: var(--muted);
      margin: 0 0 24px 0;
      font-size: 15px;
    }

    /* Input line */
    .name-input-wrap {
      width: 100%;
      max-width: 520px;
      display:flex;
      align-items:center;
      gap: 12px;
      background: var(--glass);
      border-radius: 12px;
      padding: 14px 18px;
      border: 1px solid rgba(15,149,255,0.06);
      transition: box-shadow .18s ease, transform .12s ease;
    }
    .name-input-wrap.focused {
      box-shadow: 0 6px 28px rgba(15,149,255,0.12);
      transform: translateY(-2px);
      border-color: rgba(15,149,255,0.18);
    }

    .name-input {
      border: none;
      outline: none;
      font-size: 20px;
      font-weight: 600;
      background: transparent;
      width: 100%;
      color: #0b2a4a;
    }

    .placeholder-anim {
      color: #9aa4b2;
      font-weight: 500;
    }

    .hint {
      display:flex;
      gap:8px;
      align-items:center;
      margin-top: 10px;
      color: var(--muted);
      font-size: 13px;
    }

    .enter-key {
      border: 1px solid #e6eefb;
      background: #fff;
      padding: 5px 9px;
      border-radius:6px;
      font-weight:700;
      color: var(--accent-600);
      box-shadow: 0 2px 6px rgba(11,42,74,0.04);
    }

    /* Quiz area */
    .quiz {
      display: none;
      padding-top: 6px;
      min-height: 320px;
    }

    .q-head {
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:16px;
      margin-bottom: 18px;
    }

    .q-number {
      color: var(--muted);
      font-weight: 600;
    }
    
    /* Segmented Progress Bar */
    .progress-nav {
      display: flex;
      gap: 4px;
      flex: 1;
      margin-left: 12px;
      height: 8px;
    }
    .nav-segment {
      flex: 1;
      background: #edf2ff;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .nav-segment:hover { background: #dbe4ff; }
    .nav-segment.answered { background: var(--accent); }
    .nav-segment.skipped { background: #ffc107; } /* Yellow for skipped/missed */
    .nav-segment.current {
      background: var(--accent-600);
      transform: scaleY(1.5);
      box-shadow: 0 2px 4px rgba(13,134,230,0.2);
    }

    /* Stack Animation for Single Question */
    .stack-anim {
      animation: stackEnter 0.6s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
      transform-origin: center bottom;
    }
    @keyframes stackEnter {
      0% { opacity: 0; transform: translateY(40px) scale(0.9); filter: blur(4px); }
      100% { opacity: 1; transform: translateY(0) scale(1); filter: blur(0); }
    }

    .q-card h3 { margin-top:0; font-size: 18px; color: #0b2a4a; margin-bottom: 16px; }

    .question-area {
      margin-top: 18px;
    }

    .question-text {
      font-size: 22px;
      font-weight: 700;
      color: #072038;
      margin-bottom: 20px;
      line-height: 1.4;
    }

    .options {
      display:flex;
      flex-direction:column;
      gap:12px;
      margin-top: 6px;
    }

    .opt {
      background:#fbfdff;
      padding: 16px 18px;
      border-radius: 12px;
      border: 1px solid rgba(11,42,74,0.04);
      cursor: pointer;
      font-weight: 600;
      color:#072038;
      box-shadow: 0 8px 24px rgba(12,16,40,0.04);
      transition: transform .12s ease, box-shadow .12s ease, background .12s;
      display:flex;
      align-items:center;
      gap:12px;
    }

    .opt:hover { transform: translateY(-3px); }
    .opt.selected {
      background: linear-gradient(90deg, rgba(15,149,255,0.12), rgba(13,134,230,0.06));
      border-color: rgba(15,149,255,0.18);
      box-shadow: 0 12px 32px rgba(15,149,255,0.06);
    }

    .opt .label {
      min-width: 34px;
      height: 34px;
      display:inline-grid;
      place-items:center;
      background: #fff;
      border-radius: 8px;
      font-weight:800;
      color: var(--accent-600);
      border: 1px solid rgba(15,149,255,0.08);
    }

    .navigation {
      margin-top: 26px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap: 12px;
    }

    .btn {
      padding: 12px 18px;
      border-radius: 12px;
      font-weight:700;
      border:none;
      cursor:pointer;
    }

    .btn-secondary {
      background: transparent;
      color: var(--muted);
      border: 1px solid rgba(12,16,40,0.06);
    }

    .btn-primary {
      background: linear-gradient(90deg,var(--accent),var(--accent-600));
      color: white;
      box-shadow: 0 8px 30px rgba(15,149,255,0.14);
    }
    
    /* Hide Previous Button as requested */
    #backBtn { display: none; }

    .submit-section {
      text-align: center;
      padding: 60px 0 20px 0;
      opacity: 0.3;
      transition: opacity 0.3s;
    }
    .submit-section.ready { opacity: 1; }
    
    /* Hide legacy elements */
    /* #questionText, #optionsList, .navigation { display: none !important; } REMOVED to restore single view */

    .final-screen {
      display:none;
      padding:36px;
      text-align:center;
    }

    .final-screen h2 {
      margin: 0 0 8px 0;
      font-size: 26px;
      color: #073a6b;
    }
    .final-screen p { color: var(--muted) }

    /* small screens */
    @media (max-width:720px){
      .card { padding: 24px; border-radius: 14px }
      .welcome { flex-direction: column; align-items:flex-start; gap:10px }
      .hero-title { font-size: 26px }
      .hero-sub { font-size: 14px }
      .name-input { font-size: 18px }
      .question-text { font-size: 20px }
    }

    /* subtle transitions for views */
    .view { opacity:0; transform: translateY(14px); transition: all .36s ease; }
    .view.show { opacity:1; transform: translateY(0); }

    /* Toast Notification */
    .toast-notification {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%) translateY(-20px);
      background: rgba(11, 42, 74, 0.9);
      color: #fff;
      padding: 12px 24px;
      border-radius: 99px;
      font-size: 14px;
      font-weight: 500;
      text-align: center;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
      z-index: 1000;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      pointer-events: none;
      width: max-content;
      max-width: 90%;
    }
    .toast-notification.show {
      opacity: 1;
      visibility: visible;
      transform: translateX(-50%) translateY(0);
    }

    /* Timer Urgency Animation */
    .timer-urgent {
      color: #dc3545 !important; /* A standard danger red */
      animation: pulse 1.2s infinite cubic-bezier(0.5, 0, 0.5, 1);
    }
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

  </style>
</head>
<body>

  <div class="card" role="application" aria-labelledby="quiz-heading">
    <!-- WELCOME HERO -->
    <div id="welcomeView" class="view show">
      <div class="welcome">
        <div class="welcome-left">
          <div class="eyebrow">Welcome</div>
          <h1 class="hero-title">Enter your name</h1>

          <div id="nameWrap" class="name-input-wrap" aria-hidden="false">
            <input id="studentName" class="name-input" type="text" inputmode="text" autocomplete="name" autocapitalize="words" placeholder="Type your name here..." aria-label="Student name" />
          </div>

          <div class="hint">
            <span class="enter-key">↵</span>
            <span style="color:var(--muted)">Press Enter to start the quiz</span>
          </div>
        </div>

        <!-- Right side illustration / decorative -->
        <div style="width:40%; min-width:220px; display:flex; justify-content:center; align-items:center;">
          <img src="materials/svg-logo.webp" alt="Quiz Logo" style="width:180px; height:auto;">
        </div>
      </div>
    </div>


    <!-- QUIZ VIEW -->
    <div id="quizView" class="quiz view" aria-hidden="true" role="region" aria-label="Quiz area">
      <div class="q-head">
        <div style="display:flex; align-items:center; flex: 1; margin-right: 20px;">
          <div class="q-number" id="qNumber">Question 1 / 15</div>
          <div id="progressNav" class="progress-nav" role="progressbar" aria-label="Question navigation"></div>
        </div>
        <div style="display:flex; align-items:center; gap: 16px;">
          <div id="timerDisplay" style="font-weight: 700; color: var(--accent-600); font-size: 18px; display:flex; align-items:center; gap: 6px;">
              <i class="bi bi-clock"></i>
              <span id="timerText">03:00</span>
          </div>
          <div style="min-width:110px; text-align:right; color:var(--muted); font-weight:700;" id="studentLabel">—</div>
        </div>
      </div>

      <div class="question-area">
        <!-- Content injected via JS for animation -->
      </div>

      <div class="navigation">
        <button id="backBtn" class="btn btn-secondary">← Previous</button>
        <button id="nextBtn" class="btn btn-primary">Next →</button>
      </div>
    </div>

    <!-- Toast Notification Element -->
    <div id="skipToast" class="toast-notification"></div>

    <!-- FINAL SCREEN -->
    <div id="finalView" class="final-screen view" aria-hidden="true">
      <h2>All done — nice work!</h2>
      <p id="finalMsg">You answered <span id="correctAnswersCount">0</span> questions correctly. Your teacher will see your name on the live dashboard.</p>
      <div style="margin-top:24px;" class="d-flex justify-content-center gap-3">
        <button id="doneBtn" class="btn btn-primary">Done</button>
        <a href="materials/WEEK-26_MON_WT-2.pdf" download="WEEK-26_MON_WT-2.pdf" class="btn btn-secondary">Download PDF</a>
      </div>
    </div>
  </div>

<script type="module">
  // -------------------------
  // Typeform-style Quiz (Clone)
  // Firebase (v11 modular)
  // -------------------------

  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { getDatabase, ref, set, push } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

  // === Firebase config - REPLACE with your project's config ===
  const firebaseConfig = {
    apiKey: "AIzaSy***Q",
    authDomain: "ielts-live-dashboard.firebaseapp.com",
    databaseURL: "https://ielts-live-dashboard-default-rtdb.firebaseio.com",
    projectId: "ielts-live-dashboard",
    storageBucket: "ielts-live-dashboard.firebasestorage.app",
    messagingSenderId: "1044694021318",
    appId: "1:1044694021318:web:70f1ac1ba0787d37da93c7"
  };
  // ============================================================

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  // === Quiz data (10 questions) ===
  const QUESTIONS = [
    { q:"1. Choose the grammatically correct passive form: “Researchers have recently conducted several studies on climate change.”", options:["A. Several studies have been conduct on climate change recently.","B. Several studies were being conducted on climate change recently.","C. Several studies have recently conducting on climate change.","D. Several studies have recently been conducted on climate change."], correct:"D" },
    { q:"2. Which sentence correctly uses a gerund after a reporting verb?", hint:"Some reporting verbs (e.g. <i>recommend, suggest, avoid</i>) are followed by <b>verb + ing</b>, not <i>to + verb</i>.", options:["A. The committee recommended to revise the policy immediately.","B. The committee recommended revise the policy immediately.","C. The committee recommended to revising the policy immediately.","D. The committee recommended revising the policy immediately."], correct:"D" },
    { q:"3. Identify the sentence that is grammatically correct and academically appropriate.", options:["A. There are many factors cause unemployment in cities.","B. There are many factors which cause unemployment in cities.","C. There are many factors that causing unemployment in cities.","D. There are many factors that cause unemployment in cities."], correct:"D" },
    { q:"4. Choose the correctly structured complex sentence with logical subordination.", options:["A. Public transport was improved, congestion was reduced.","B. Public transport was improved and congestion reducing.","C. Public transport was improved, reducing congestion in cities.","D. Public transport was improved because congestion had become severe."], correct:"D" },
    { q:"5. Which option demonstrates correct control of clause structure?", hint:"When using <i>while</i>, check that <b>both clauses are complete and grammatically balanced</b>.", options:["A. While the economy expanded, unemployment reducing.","B. While the economy expanded, unemployment reduce.","C. While the economy expanded, unemployment was reduce.","D. While the economy expanded, unemployment was reduced."], correct:"D" },
    { q:"6. Choose the sentence with correct infinitive usage.", hint:"After verbs like <i>aim, plan, decide</i>, use <b>to + base verb</b>.", options:["A. The government aims reducing inequality through education.","B. The government aims reduce inequality through education.","C. The government aims to reducing inequality through education.","D. The government aims to reduce inequality through education."], correct:"D" },
    { q:"7. Which sentence reflects accurate grammatical control expected in IELTS Task 2?", options:["A. The data analysed by experts reveal a clear trend.","B. The data was analysed and reveal a clear trend.","C. The data analysed reveals clear trend.","D. The data analysed by experts reveal a clear trend."], correct:"D" },
    { q:"8. A line graph shows that internet usage rose sharply between 2005 and 2010, before levelling off until 2020. Which statement is MOST accurate?", options:["A. Internet usage declined steadily after 2010.","B. Internet usage fluctuated considerably throughout the period.","C. Internet usage continued to rise at the same pace after 2010.","D. Internet usage increased rapidly initially and then stabilised."], correct:"D" },
    { q:"9. What does the word “adamant” most precisely mean?", options:["A. Willing to negotiate under pressure","B. Uncertain about one’s stance","C. Open to alternative viewpoints","D. Refusing to change one’s mind; unyielding"], correct:"D" },
    { q:"10. What is the closest meaning of “allure” in academic context?", options:["A. A logical explanation","B. A temporary trend","C. A financial incentive","D. The power to attract or charm"], correct:"D" }
  ];

  // State
  let studentName = "";
  let idx = 0;
  const skippedQuestions = new Set(); // Track explicitly skipped questions
  const answers = Array(QUESTIONS.length).fill(null); // store selected letter "A"/"B"/...
  const studentLabelEl = document.getElementById("studentLabel");
  let quizTimerInterval = null;
  let timeRemaining = 180; // 3 minutes
  let isQuizActive = false;

  // Elements
  const welcomeView = document.getElementById("welcomeView");
  const quizView = document.getElementById("quizView");
  const finalView = document.getElementById("finalView");
  const nameInput = document.getElementById("studentName");
  const nameWrap = document.getElementById("nameWrap");
  const qNumber = document.getElementById("qNumber");
  const progressNav = document.getElementById("progressNav");
  const nextBtn = document.getElementById("nextBtn");
  const backBtn = document.getElementById("backBtn");
  const doneBtn = document.getElementById("doneBtn");
  const correctAnswersCountEl = document.getElementById("correctAnswersCount");
  const timerTextEl = document.getElementById("timerText");
  const skipToast = document.getElementById("skipToast");

  // Helper: uppercase and sanitize student name for key
  function sanitizeName(n){
    if(!n) return "";
    return n.trim().toUpperCase().replace(/\s+/g,' ');
  }

  // Welcome behavior
  nameInput.addEventListener("focus", ()=> nameWrap.classList.add("focused"));
  nameInput.addEventListener("blur", ()=> nameWrap.classList.remove("focused"));

  nameInput.addEventListener("keydown", (e)=>{
    if(e.key === "Enter"){
      e.preventDefault();
      startQuizFlow();
    }
  });

  // Start quiz: validate name & transition
  function startQuizFlow(){
    const raw = nameInput.value || "";
    const cleaned = sanitizeName(raw);
    if(!cleaned){
      // slight shake
      nameWrap.animate([{transform:"translateX(0)"},{transform:"translateX(-8px)"},{transform:"translateX(8px)"},{transform:"translateX(0)"}], {duration:220});
      return;
    }
    studentName = cleaned;
    studentLabelEl.textContent = studentName;
    // animate transition
    welcomeView.classList.remove("show");
    setTimeout(()=>{
      welcomeView.style.display = "none";
      quizView.style.display = "block";
      setTimeout(()=> quizView.classList.add("show"), 10);
      loadQuestion(idx);
      // renderQuizList(); // Removed
      startTimer();
    }, 200);
  }

  // Timer Logic
  function startTimer() {
    isQuizActive = true;
    timeRemaining = 180; // 3 minutes
    updateTimerDisplay();

    quizTimerInterval = setInterval(() => {
      timeRemaining--;
      updateTimerDisplay();

      if (timeRemaining <= 0) {
        clearInterval(quizTimerInterval);
        isQuizActive = false;
        alert("Time's up! Your quiz will be submitted automatically.");
        disableQuizControls();
        // disableQuizControls(); // Not strictly needed if we submit immediately
        submitQuiz();
      }
    }, 1000);
  }

  function updateTimerDisplay() {
    const min = Math.floor(timeRemaining / 60).toString().padStart(2, '0');
    const sec = (timeRemaining % 60).toString().padStart(2, '0');
    timerTextEl.textContent = `${min}:${sec}`;

    if (timeRemaining < 60 && isQuizActive) {
      document.getElementById('timerDisplay').classList.add('timer-urgent');
    } else {
      document.getElementById('timerDisplay').classList.remove('timer-urgent');
    }
  }

  function disableQuizControls() {
    document.querySelectorAll('.opt').forEach(opt => opt.disabled = true);
    nextBtn.disabled = true;
    backBtn.disabled = true;
  }

  // Render the segmented progress bar
  function renderProgressNav() {
    progressNav.innerHTML = "";
    QUESTIONS.forEach((_, i) => {
      const seg = document.createElement("div");
      seg.className = "nav-segment";
      
      if (i === idx) seg.classList.add("current");
      else if (answers[i] !== null) seg.classList.add("answered");
      else if (skippedQuestions.has(i)) seg.classList.add("skipped"); // Yellow if explicitly skipped

      // Allow jumping to any question
      seg.title = `Go to Question ${i + 1}`;
      seg.addEventListener("click", () => {
        if (i !== idx) transitionToQuestion(i);
      });
      
      progressNav.appendChild(seg);
    });
  }

  // Load question
  function loadQuestion(i){
    idx = i;

    // update head
    qNumber.textContent = `Question ${idx+1} / ${QUESTIONS.length}`;
    renderProgressNav();

    // Create fresh content container for animation
    const qArea = document.querySelector('.question-area');
    qArea.innerHTML = ""; // Clear previous
    
    const contentWrap = document.createElement("div");
    contentWrap.className = "stack-anim";

    // fill question and options
    const q = QUESTIONS[idx];
    
    const qText = document.createElement("div");
    qText.className = "question-text";
    qText.textContent = q.q;
    contentWrap.appendChild(qText);

    // Add Hint if available
    if(q.hint){
      const hintDiv = document.createElement("div");
      hintDiv.style.cssText = "background:rgba(255,193,7,0.12); color:#856404; padding:12px 16px; border-radius:12px; margin-bottom:20px; font-size:14px; display:flex; gap:10px; align-items:start; border:1px solid rgba(255,193,7,0.2);";
      hintDiv.innerHTML = `<i class="bi bi-lightbulb-fill" style="margin-top:2px; color:#ffc107;"></i><div><strong>Hint:</strong> ${q.hint}</div>`;
      contentWrap.appendChild(hintDiv);
    }

    const optsList = document.createElement("div");
    optsList.className = "options";
    optsList.setAttribute("role", "listbox");

    q.options.forEach((optText, j)=>{
      const letter = String.fromCharCode(65 + j); // A,B,C...
      const opt = document.createElement("button");
      opt.type = "button";
      opt.className = "opt";
      opt.setAttribute("role","option");
      opt.innerHTML = `<span class="label">${letter}</span><span style="flex:1">${optText.replace(/^([A-D]\.\s*)/,'')}</span>`;
      // mark if previously selected
      if(answers[idx] === letter) opt.classList.add("selected");
      
      opt.addEventListener("click", ()=>{
        // clear selection siblings
        const wasSkipped = skippedQuestions.has(idx);
        const isFirstAttempt = answers[idx] === null && !wasSkipped;

        optsList.querySelectorAll(".opt").forEach(o=>o.classList.remove("selected"));
        opt.classList.add("selected");
        answers[idx] = letter;
        
        // Update button text immediately
        nextBtn.textContent = (idx === QUESTIONS.length - 1) ? "Submit" : "Next →";

        if (wasSkipped) skippedQuestions.delete(idx);
        renderProgressNav(); // Update nav to show answered state

        // Auto-advance logic (Typeform style) - ONLY on first attempt
        if (isFirstAttempt && idx < QUESTIONS.length - 1) {
          setTimeout(() => {
            // Only advance if user hasn't manually moved yet
            if (idx === i) {
              transitionToQuestion(idx + 1);
            }
          }, 350); // Short delay for smooth feel
        }
      });
      optsList.appendChild(opt);
    });
    
    contentWrap.appendChild(optsList);
    qArea.appendChild(contentWrap);

    // update buttons visibility
    // backBtn is hidden via CSS, but we keep logic just in case
    // If no answer, Next acts as Skip
    nextBtn.textContent = (idx === QUESTIONS.length - 1) ? "Submit" : (answers[idx] ? "Next →" : "Skip");
  }

  // Helper for smooth transition
  function transitionToQuestion(targetIdx) {
    // Just call loadQuestion, the animation is handled inside it via CSS class reset
    loadQuestion(targetIdx);
  }

  // Navigation
  backBtn.addEventListener("click", ()=>{
    if(idx > 0){
      transitionToQuestion(idx - 1);
    }
  });

  let toastTimeout;
  function showToast(msg) {
    skipToast.textContent = msg;
    skipToast.classList.add("show");
    clearTimeout(toastTimeout);
    toastTimeout = setTimeout(() => {
      skipToast.classList.remove("show");
    }, 4000);
  }

  nextBtn.addEventListener("click", ()=>{
    // If no answer selected, mark as skipped
    if (answers[idx] === null) {
      skippedQuestions.add(idx);
      const name = studentName || "Student";
      showToast(`${name}, you have skipped question ${idx + 1}, tap on the yellow color bar to quickly jump to that question`);
    }
    if(idx < QUESTIONS.length - 1){
      transitionToQuestion(idx + 1);
    } else {
      // final submit
      submitQuiz();
    }
  });

  // Mobile Swipe Logic
  let touchStartX = 0;
  let touchEndX = 0;
  
  quizView.addEventListener('touchstart', e => {
    touchStartX = e.changedTouches[0].screenX;
  }, {passive: true});

  quizView.addEventListener('touchend', e => {
    touchEndX = e.changedTouches[0].screenX;
    handleSwipe();
  }, {passive: true});

  function handleSwipe() {
    // Swipe Left (Right to Left) -> Next/Skip
    if (touchStartX - touchEndX > 50) {
      nextBtn.click();
    }
  }

  // keyboard shortcuts: number or letter to choose, enter to next
  document.addEventListener("keydown", (e)=>{
    if(!isQuizActive || welcomeView.style.display !== "none") return; // only during active quiz
    if(["1","2","3","4","5","6","7","8","9"].includes(e.key) && (parseInt(e.key) <= QUESTIONS[idx].options.length)){
      const choiceIndex = parseInt(e.key)-1;
      const optButtons = document.querySelectorAll(".opt");
      if(optButtons[choiceIndex]) optButtons[choiceIndex].click();
    }
    if(e.key.length === 1 && e.key.toLowerCase() >= 'a' && e.key.toLowerCase() <= 'd'){
      const ch = e.key.toUpperCase();
      const letterIndex = ch.charCodeAt(0)-65;
      if(letterIndex >=0 && letterIndex < QUESTIONS[idx].options.length){
        const optButtons = document.querySelectorAll(".opt");
        if(optButtons[letterIndex]) optButtons[letterIndex].click();
      }
    }
    if(e.key === "Enter"){
      // if focus is inside name input, handled earlier
      if(document.activeElement && document.activeElement === nameInput) return;
      e.preventDefault();
      // mimic next button click
      nextBtn.click();
    }
    // Disabled keyboard shortcuts for now as they rely on single-question view logic
    // or need complex logic to find "current" card in scroll view.
    // Keeping it simple as requested.
  });

  // Prevent accidental tab close while quiz is active
  window.addEventListener('beforeunload', (e) => {
    if (isQuizActive) {
      // Standard way to trigger the browser's confirmation dialog
      e.preventDefault();
      e.returnValue = 'Are you sure you want to leave? Your progress will be lost.';
    }
  });

  // Submit => compute score and push to Firebase under student's NAME (uppercase)
  async function submitQuiz(){
    if (quizTimerInterval) clearInterval(quizTimerInterval); // Stop timer on manual submit
    isQuizActive = false;

    // compute correct count, incorrect, missed
    let correctCount = 0;
    let missedCount = 0;
    const incorrectList = [];
    const missedList = [];

    QUESTIONS.forEach((Q, i)=>{
      const ans = answers[i];
      if(ans === null){
        missedCount++;
        missedList.push(`Q${i+1}`);
      } else {
        if(ans === Q.correct) correctCount++;
        else {
          incorrectList.push(`Q${i+1}`);
        }
      }
    });

    const total = QUESTIONS.length;
    const incorrectCount = total - correctCount - missedCount;
    const correctPct = ((correctCount / total) * 100).toFixed(1) + "%";
    const incorrectPct = ((incorrectCount / total) * 100).toFixed(1) + "%";
    const missedPct = ((missedCount / total) * 100).toFixed(1) + "%";
    const incorrectQuestionsStr = incorrectList.length ? incorrectList.join(", ") : "-";
    const missedQuestionsStr = missedList.length ? missedList.join(", ") : "-";

    // Create a result payload matching teacher-report expected fields
    const studentKey = sanitizeName(studentName) || ("ANON_" + Date.now());
    const payload = {
      taskId: studentKey,        // teacher-report expects taskId; now this will be the student's name in UPPERCASE
      correct: correctPct,
      rawCorrectCount: correctCount, // Added raw correct count
      incorrect: incorrectPct,
      missed: missedPct,
      incorrectQuestions: incorrectQuestionsStr, // New field
      missedQuestions: missedQuestionsStr,     // New field
      rawAnswers: answers,       // optional — useful for debugging / analysis
      timestamp: Date.now()
    };

    try {
      // Write to /quizResults/<studentKey>
      // We use set(...) to overwrite existing student name entry so the latest attempt replaces the earlier one
      const targetRef = ref(db, `quizResults/${studentKey}`);
      await set(targetRef, payload);

      // show final view
      quizView.classList.remove("show");
      setTimeout(()=>{
        correctAnswersCountEl.textContent = correctCount; // Update the display
        quizView.style.display = "none";
        finalView.style.display = "block";
        finalView.classList.add("show");
      }, 180);
    } catch(err){
      console.error("Firebase write error:", err);
      alert("Could not save your result right now. Check network or Firebase config.");
    }
  }

  // When Done clicked => optionally reset or redirect
  doneBtn.addEventListener("click", ()=>{
    // simple reset to welcome screen (keeps name for convenience)
    finalView.classList.remove("show");
    setTimeout(()=>{
      finalView.style.display = "none";
      welcomeView.style.display = "block";
      setTimeout(()=> {
        welcomeView.classList.add("show");
        // reset state
        idx = 0;
        for(let i=0;i<answers.length;i++) answers[i] = null;
        skippedQuestions.clear();
        nameInput.value = "";
        studentName = "";
        studentLabelEl.textContent = "—";
        quizView.style.display = "none";
        // Re-enable buttons for next attempt
        nextBtn.disabled = false;
        backBtn.disabled = false;
        isQuizActive = false;
        timeRemaining = 180;
        document.getElementById('timerDisplay').classList.remove('timer-urgent');
      }, 10);
    }, 160);
  });

  // Initialize: hide quiz/final views until start
  quizView.style.display = "none";
  finalView.style.display = "none";

  // Auto-focus the name input
  nameInput.focus();

  // Make Next button enabled only when an option is selected (handled by click)
  // Small accessibility: allow click on the entire card to focus name input
  document.querySelector('.card').addEventListener('click', (e)=>{
    if(welcomeView.style.display !== "none"){
      nameInput.focus();
    }
  });

  // END module
</script>
</body>
</html>
